<div class="new-request-container">
  <nav class="new-request-breadcrumbs">
    <ol class="breadcrumbs">
      <li class="breadcrumbs-item">
        <a href="{{help_center.url}}">{{help_center.name}}</a>
      </li>
      <li class="breadcrumbs-item">
        <a href="{{help_center.url}}/requests">ã‚µãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ</a>
      </li>
      <li class="breadcrumbs-item">
        æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      </li>
    </ol>
  </nav>

  <header class="new-request-header">
    <div class="new-request-title-section">
      <h1 class="new-request-title">æ–°ã—ã„ã‚µãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h1>
      <p class="new-request-description">
        ãŠå›°ã‚Šã®ã“ã¨ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€è©³ç´°ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚å°‚é–€ã‚µãƒãƒ¼ãƒˆã‚¹ã‚¿ãƒƒãƒ•ãŒè¿…é€Ÿã«å¯¾å¿œã„ãŸã—ã¾ã™ã€‚
      </p>
    </div>
  </header>

  <main class="new-request-main">
    <div class="request-form-container">
      <form class="new-request-form" method="post" action="{{help_center.url}}/requests" enctype="multipart/form-data">
        
        <!-- Basic Information Section -->
        <div class="form-section form-section--basic">
          <h2 class="form-section-title">åŸºæœ¬æƒ…å ±</h2>
          
          <div class="form-row">
            <div class="form-group form-group--half">
              <label for="request-requester-name" class="form-label required">ãŠåå‰</label>
              <input type="text" id="request-requester-name" name="request[requester][name]" 
                     class="form-input" placeholder="å±±ç”° å¤ªéƒ" required
                     value="{{current_user.name}}">
            </div>
            
            <div class="form-group form-group--half">
              <label for="request-requester-email" class="form-label required">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" id="request-requester-email" name="request[requester][email]" 
                     class="form-input" placeholder="your@email.com" required
                     value="{{current_user.email}}">
              <div class="form-hint">è¿”ä¿¡ã‚’ãŠé€ã‚Šã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™</div>
            </div>
          </div>

          {{#if organizations}}
          <div class="form-group">
            <label for="request-organization" class="form-label">çµ„ç¹”</label>
            <select id="request-organization" name="request[organization_id]" class="form-select">
              <option value="">å€‹äººã¨ã—ã¦é€ä¿¡</option>
              {{#each organizations}}
              <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
              {{/each}}
            </select>
          </div>
          {{/if}}
        </div>

        <!-- Request Details Section -->
        <div class="form-section form-section--details">
          <h2 class="form-section-title">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°</h2>
          
          <div class="form-group">
            <label for="request-subject" class="form-label required">ä»¶å</label>
            <input type="text" id="request-subject" name="request[subject]" 
                   class="form-input form-input--large" 
                   placeholder="å•é¡Œã®æ¦‚è¦ã‚’å…·ä½“çš„ã«è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã€æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„ç­‰ï¼‰" 
                   required maxlength="255">
            <div class="form-hint">å•é¡Œã‚’ä¸€ç›®ã§ç†è§£ã§ãã‚‹å…·ä½“çš„ãªä»¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§255æ–‡å­—ï¼‰</div>
          </div>

          {{#if ticket_forms}}
          <div class="form-group">
            <label for="request-ticket-form" class="form-label">ãŠå•ã„åˆã‚ã›ã®ç¨®é¡</label>
            <select id="request-ticket-form" name="request[ticket_form_id]" class="form-select">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {{#each ticket_forms}}
              <option value="{{id}}">{{name}}</option>
              {{/each}}
            </select>
            <div class="form-hint">ãŠå•ã„åˆã‚ã›å†…å®¹ã«æœ€ã‚‚é©ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
          {{/if}}

          <div class="form-group">
            <label for="request-description" class="form-label required">è©³ç´°èª¬æ˜</label>
            <div class="editor-toolbar">
              <div class="editor-format-buttons">
                <button type="button" class="format-btn" data-format="bold" title="å¤ªå­—">
                  <strong>B</strong>
                </button>
                <button type="button" class="format-btn" data-format="italic" title="æ–œä½“">
                  <em>I</em>
                </button>
                <button type="button" class="format-btn" data-format="code" title="ã‚³ãƒ¼ãƒ‰">
                  &lt;/&gt;
                </button>
                <button type="button" class="format-btn" data-format="list" title="ãƒªã‚¹ãƒˆ">
                  â‰¡
                </button>
                <button type="button" class="format-btn" data-format="quote" title="å¼•ç”¨">
                  "
                </button>
              </div>
              <div class="editor-help">
                <button type="button" class="help-btn" onclick="toggleMarkdownHelp()">ğŸ“ æ›¸å¼ãƒ˜ãƒ«ãƒ—</button>
              </div>
            </div>
            <textarea id="request-description" name="request[comment][body]" 
                      class="form-textarea form-textarea--large" required rows="10"
                      placeholder="å•é¡Œã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„...&#10;&#10;ä»¥ä¸‹ã®æƒ…å ±ãŒã‚ã‚‹ã¨è¿…é€Ÿãªè§£æ±ºã«å½¹ç«‹ã¡ã¾ã™ï¼š&#10;â€¢ å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªæ‰‹é †&#10;â€¢ æœŸå¾…ã—ã¦ã„ãŸçµæœã¨å®Ÿéš›ã«èµ·ã“ã£ãŸçµæœ&#10;â€¢ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰&#10;â€¢ ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã€OSç­‰ï¼‰&#10;â€¢ å•é¡ŒãŒæœ€åˆã«ç™ºç”Ÿã—ãŸæ—¥æ™‚"></textarea>
            
            <div class="markdown-help" id="markdown-help" style="display: none;">
              <h4>æ›¸å¼è¨­å®šã®ãƒ˜ãƒ«ãƒ—</h4>
              <div class="markdown-examples">
                <div class="markdown-row">
                  <code>**å¤ªå­—**</code> â†’ <strong>å¤ªå­—</strong>
                </div>
                <div class="markdown-row">
                  <code>*æ–œä½“*</code> â†’ <em>æ–œä½“</em>
                </div>
                <div class="markdown-row">
                  <code>`ã‚³ãƒ¼ãƒ‰`</code> â†’ <code>ã‚³ãƒ¼ãƒ‰</code>
                </div>
                <div class="markdown-row">
                  <code>> å¼•ç”¨</code> â†’ å¼•ç”¨ãƒ–ãƒ­ãƒƒã‚¯
                </div>
                <div class="markdown-row">
                  <code>- ãƒªã‚¹ãƒˆé …ç›®</code> â†’ â€¢ ãƒªã‚¹ãƒˆé …ç›®
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Priority and Classification -->
        <div class="form-section form-section--classification">
          <h2 class="form-section-title">å„ªå…ˆåº¦ãƒ»åˆ†é¡</h2>
          
          {{#if priority_options}}
          <div class="form-group">
            <label class="form-label">å„ªå…ˆåº¦</label>
            <div class="priority-selection">
              {{#each priority_options}}
              <label class="priority-option">
                <input type="radio" name="request[priority]" value="{{value}}" 
                       class="priority-radio" {{#if default}}checked{{/if}}>
                <div class="priority-card priority-card--{{value}}">
                  <div class="priority-indicator">
                    <div class="priority-icon">
                      {{#is value 'urgent'}}ğŸ”´{{/is}}
                      {{#is value 'high'}}ğŸŸ {{/is}}
                      {{#is value 'normal'}}ğŸŸ¡{{/is}}
                      {{#is value 'low'}}ğŸŸ¢{{/is}}
                    </div>
                  </div>
                  <div class="priority-content">
                    <div class="priority-name">{{name}}</div>
                    <div class="priority-description">
                      {{#is value 'urgent'}}æ¥­å‹™åœæ­¢ãƒ¬ãƒ™ãƒ« - å³åº§ã®å¯¾å¿œãŒå¿…è¦{{/is}}
                      {{#is value 'high'}}é‡è¦ãªæ©Ÿèƒ½ã«å½±éŸ¿ - 24æ™‚é–“ä»¥å†…ã«å¯¾å¿œ{{/is}}
                      {{#is value 'normal'}}é€šå¸¸ã®å•é¡Œ - 2-3å–¶æ¥­æ—¥ã§å¯¾å¿œ{{/is}}
                      {{#is value 'low'}}è»½å¾®ãªå•é¡Œ - 1é€±é–“ä»¥å†…ã«å¯¾å¿œ{{/is}}
                    </div>
                  </div>
                </div>
              </label>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{#if custom_fields}}
          <div class="form-group">
            <h3 class="form-subsection-title">è¿½åŠ æƒ…å ±</h3>
            <div class="custom-fields-grid">
              {{#each custom_fields}}
              <div class="form-group custom-field">
                <label for="custom-field-{{id}}" class="form-label {{#if required}}required{{/if}}">
                  {{title}}
                </label>
                
                {{#is type 'text'}}
                <input type="text" id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                       class="form-input" {{#if required}}required{{/if}} 
                       placeholder="{{description}}">
                {{/is}}
                
                {{#is type 'textarea'}}
                <textarea id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                          class="form-textarea" rows="3" {{#if required}}required{{/if}}
                          placeholder="{{description}}"></textarea>
                {{/is}}
                
                {{#is type 'dropdown'}}
                <select id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                        class="form-select" {{#if required}}required{{/if}}>
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                  {{#each options}}
                  <option value="{{value}}">{{name}}</option>
                  {{/each}}
                </select>
                {{/is}}
                
                {{#is type 'multiselect'}}
                <div class="multiselect-options">
                  {{#each options}}
                  <label class="checkbox-option">
                    <input type="checkbox" name="request[custom_fields][{{../id}}][]" 
                           value="{{value}}" class="checkbox-input">
                    <span class="checkbox-label">{{name}}</span>
                  </label>
                  {{/each}}
                </div>
                {{/is}}
                
                {{#if description}}
                <div class="field-description">{{description}}</div>
                {{/if}}
              </div>
              {{/each}}
            </div>
          </div>
          {{/if}}
        </div>

        <!-- Attachments Section -->
        <div class="form-section form-section--attachments">
          <h2 class="form-section-title">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h2>
          
          <div class="form-group">
            <label for="request-attachments" class="form-label">é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®æ·»ä»˜</label>
            <div class="file-upload-area" id="file-upload-area">
              <input type="file" id="request-attachments" name="request[comment][attachments][]" 
                     class="file-input" multiple 
                     accept="image/*,.pdf,.doc,.docx,.txt,.zip,.log,.csv,.json">
              <label for="request-attachments" class="file-upload-label">
                <div class="upload-content">
                  <span class="upload-icon">ğŸ“</span>
                  <span class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</span>
                  <span class="upload-subtext">è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠãŒå¯èƒ½ã§ã™</span>
                </div>
              </label>
              <div class="file-list" id="file-list"></div>
            </div>
            <div class="file-upload-info">
              <div class="file-types">
                <strong>æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«:</strong> ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¨ãƒ©ãƒ¼ç”»é¢
              </div>
              <div class="file-formats">
                <strong>å¯¾å¿œå½¢å¼:</strong> ç”»åƒï¼ˆPNG, JPG, GIFï¼‰ã€PDFã€Wordæ–‡æ›¸ã€ãƒ†ã‚­ã‚¹ãƒˆã€ZIPã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
              </div>
              <div class="file-size-limit">
                <strong>ã‚µã‚¤ã‚ºåˆ¶é™:</strong> 1ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§10MBã€åˆè¨ˆ50MB
              </div>
            </div>
          </div>
        </div>

        <!-- Collaboration Settings -->
        <div class="form-section form-section--collaboration">
          <h2 class="form-section-title">å…±æœ‰è¨­å®š</h2>
          
          <div class="form-group">
            <div class="collaboration-options">
              {{#if current_user.organization}}
              <label class="collaboration-checkbox">
                <input type="checkbox" name="request[collaborator_ids][]" 
                       value="{{current_user.organization.id}}" class="checkbox-input">
                <span class="checkbox-content">
                  <span class="checkbox-label">çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®å…±æœ‰</span>
                  <span class="checkbox-description">
                    çµ„ç¹”å†…ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–²è¦§ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
                  </span>
                </span>
              </label>
              {{/if}}
              
              <label class="collaboration-checkbox">
                <input type="checkbox" name="request[public]" value="true" class="checkbox-input">
                <span class="checkbox-content">
                  <span class="checkbox-label">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®å…¬é–‹</span>
                  <span class="checkbox-description">
                    ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚è€ƒã«ã§ãã‚‹ã‚ˆã†ã€è§£æ±ºå¾Œã«ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§å…¬é–‹ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™
                  </span>
                </span>
              </label>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <div class="form-actions-main">
            <button type="submit" class="btn btn-primary btn-large">
              <span class="btn-icon">ğŸ“¤</span>
              <span class="btn-text">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡</span>
            </button>
            <button type="button" class="btn btn-secondary btn-preview" onclick="showPreview()">
              <span class="btn-icon">ğŸ‘ï¸</span>
              <span class="btn-text">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            </button>
          </div>
          
          <div class="form-actions-secondary">
            <button type="button" class="btn btn-tertiary btn-draft" onclick="saveDraft()">
              <span class="btn-icon">ğŸ’¾</span>
              <span class="btn-text">ä¸‹æ›¸ãä¿å­˜</span>
            </button>
            <a href="{{help_center.url}}" class="btn btn-link">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </a>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Sidebar -->
  <aside class="new-request-sidebar">
    <!-- Quick Help -->
    <div class="sidebar-section quick-help">
      <h3 class="sidebar-title">ğŸ’¡ åŠ¹æœçš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ„</h3>
      <div class="help-tips">
        <div class="help-tip">
          <div class="tip-icon">ğŸ¯</div>
          <div class="tip-content">
            <div class="tip-title">å…·ä½“çš„ãªä»¶å</div>
            <div class="tip-description">ã€Œãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€ã§ã¯ãªãã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå¾Œã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç¶šãã€</div>
          </div>
        </div>
        
        <div class="help-tip">
          <div class="tip-icon">ğŸ“‹</div>
          <div class="tip-content">
            <div class="tip-title">å†ç¾æ‰‹é †ã‚’è¨˜è¼‰</div>
            <div class="tip-description">å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªæ“ä½œæ‰‹é †ã‚’é †ç•ªã«è¨˜è¼‰</div>
          </div>
        </div>
        
        <div class="help-tip">
          <div class="tip-icon">ğŸ“·</div>
          <div class="tip-content">
            <div class="tip-title">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ·»ä»˜</div>
            <div class="tip-description">ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚„å•é¡Œç®‡æ‰€ã®ç”»åƒãŒã‚ã‚‹ã¨ç†è§£ãŒæ—©ã¾ã‚Šã¾ã™</div>
          </div>
        </div>
        
        <div class="help-tip">
          <div class="tip-icon">ğŸ”</div>
          <div class="tip-content">
            <div class="tip-title">äº‹å‰ã«æ¤œç´¢</div>
            <div class="tip-description">é¡ä¼¼ã®å•é¡ŒãŒãªã„ã‹ãƒ˜ãƒ«ãƒ—ã‚»ãƒ³ã‚¿ãƒ¼ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Support Information -->
    <div class="sidebar-section support-info">
      <h3 class="sidebar-title">ğŸ“ ã‚µãƒãƒ¼ãƒˆæƒ…å ±</h3>
      <div class="support-details">
        <div class="support-hours">
          <h4>å–¶æ¥­æ™‚é–“</h4>
          <div class="hours-list">
            <div class="hours-item">
              <span class="day">å¹³æ—¥</span>
              <span class="time">9:00 - 18:00</span>
            </div>
            <div class="hours-item">
              <span class="day">åœŸæ—¥ãƒ»ç¥æ—¥</span>
              <span class="time">ä¼‘æ¥­</span>
            </div>
          </div>
        </div>
        
        <div class="response-times">
          <h4>ç›®å®‰å›ç­”æ™‚é–“</h4>
          <div class="response-list">
            <div class="response-item response-urgent">
              <span class="priority">ç·Šæ€¥</span>
              <span class="time">2æ™‚é–“ä»¥å†…</span>
            </div>
            <div class="response-item response-high">
              <span class="priority">é«˜</span>
              <span class="time">24æ™‚é–“ä»¥å†…</span>
            </div>
            <div class="response-item response-normal">
              <span class="priority">é€šå¸¸</span>
              <span class="time">2-3å–¶æ¥­æ—¥</span>
            </div>
            <div class="response-item response-low">
              <span class="priority">ä½</span>
              <span class="time">1é€±é–“ä»¥å†…</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alternative Support -->
    <div class="sidebar-section alternative-support">
      <h3 class="sidebar-title">ğŸ”„ ãã®ä»–ã®ã‚µãƒãƒ¼ãƒˆæ–¹æ³•</h3>
      <div class="support-alternatives">
        {{#if help_center.phone}}
        <div class="support-method">
          <div class="method-icon">ğŸ“</div>
          <div class="method-content">
            <div class="method-name">é›»è©±ã‚µãƒãƒ¼ãƒˆ</div>
            <div class="method-info">{{help_center.phone}}</div>
            <div class="method-hours">å¹³æ—¥ 9:00-17:00</div>
          </div>
        </div>
        {{/if}}

        {{#if community.url}}
        <div class="support-method">
          <div class="method-icon">ğŸ’¬</div>
          <div class="method-content">
            <div class="method-name">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</div>
            <a href="{{community.url}}" class="method-link">è³ªå•ã‚’æŠ•ç¨¿</a>
            <div class="method-description">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æƒ…å ±äº¤æ›</div>
          </div>
        </div>
        {{/if}}

        {{#if help_center.chat_enabled}}
        <div class="support-method">
          <div class="method-icon">ğŸ’­</div>
          <div class="method-content">
            <div class="method-name">ãƒãƒ£ãƒƒãƒˆã‚µãƒãƒ¼ãƒˆ</div>
            <button class="method-link" onclick="openChat()">ãƒãƒ£ãƒƒãƒˆé–‹å§‹</button>
            <div class="method-description">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾å¿œ</div>
          </div>
        </div>
        {{/if}}
      </div>
    </div>

    <!-- Related Articles -->
    {{#if related_articles}}
    <div class="sidebar-section related-articles">
      <h3 class="sidebar-title">ğŸ“š é–¢é€£è¨˜äº‹</h3>
      <ul class="articles-list">
        {{#each related_articles}}
        <li class="article-item">
          <a href="{{url}}" class="article-link">{{title}}</a>
        </li>
        {{/each}}
      </ul>
    </div>
    {{/if}}
  </aside>
</div>

<!-- Preview Modal -->
<div class="preview-modal" id="preview-modal" style="display: none;">
  <div class="preview-overlay" onclick="closePreview()"></div>
  <div class="preview-content">
    <div class="preview-header">
      <h3 class="preview-title">ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <button class="preview-close" onclick="closePreview()">Ã—</button>
    </div>
    <div class="preview-body" id="preview-body">
      <!-- Preview content will be inserted here -->
    </div>
    <div class="preview-footer">
      <button class="btn btn-primary" onclick="closePreview()">ç·¨é›†ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeNewRequestPage();
});

function initializeNewRequestPage() {
  setupFileUpload();
  setupFormValidation();
  setupTextFormatting();
  setupDraftFunctionality();
  setupAutoSave();
}

// File Upload Functionality
function setupFileUpload() {
  const fileInput = document.getElementById('request-attachments');
  const uploadArea = document.getElementById('file-upload-area');
  const fileList = document.getElementById('file-list');
  
  fileInput.addEventListener('change', function() {
    handleFileSelection(this.files);
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', handleDragOver);
  uploadArea.addEventListener('dragleave', handleDragLeave);
  uploadArea.addEventListener('drop', handleDrop);
  
  function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  }
  
  function handleDragLeave(e) {
    e.preventDefault();
    if (!uploadArea.contains(e.relatedTarget)) {
      uploadArea.classList.remove('drag-over');
    }
  }
  
  function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    fileInput.files = files;
    handleFileSelection(files);
  }
  
  function handleFileSelection(files) {
    displayFiles(files);
    validateFiles(files);
  }
  
  function displayFiles(files) {
    fileList.innerHTML = '';
    let totalSize = 0;
    
    Array.from(files).forEach((file, index) => {
      totalSize += file.size;
      
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <div class="file-info">
          <div class="file-icon">${getFileIcon(file.type)}</div>
          <div class="file-details">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
        </div>
        <button type="button" class="file-remove" onclick="removeFile(${index})" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤">Ã—</button>
      `;
      
      fileList.appendChild(fileItem);
    });
    
    // Show total size
    if (files.length > 1) {
      const totalItem = document.createElement('div');
      totalItem.className = 'file-total';
      totalItem.innerHTML = `<strong>åˆè¨ˆ: ${files.length}ãƒ•ã‚¡ã‚¤ãƒ« (${formatFileSize(totalSize)})</strong>`;
      fileList.appendChild(totalItem);
    }
  }
  
  function validateFiles(files) {
    const maxFileSize = 10 * 1024 * 1024; // 10MB
    const maxTotalSize = 50 * 1024 * 1024; // 50MB
    let totalSize = 0;
    let hasError = false;
    
    Array.from(files).forEach(file => {
      totalSize += file.size;
      if (file.size > maxFileSize) {
        showError(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã®ã‚µã‚¤ã‚ºãŒ10MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
        hasError = true;
      }
    });
    
    if (totalSize > maxTotalSize) {
      showError('æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºãŒ50MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');
      hasError = true;
    }
    
    return !hasError;
  }
  
  function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'ğŸ–¼ï¸';
    if (mimeType.includes('pdf')) return 'ğŸ“„';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'ğŸ“';
    if (mimeType.includes('text')) return 'ğŸ“ƒ';
    if (mimeType.includes('zip') || mimeType.includes('archive')) return 'ğŸ“¦';
    return 'ğŸ“';
  }
}

// Text Formatting
function setupTextFormatting() {
  const formatButtons = document.querySelectorAll('.format-btn');
  const textarea = document.getElementById('request-description');
  
  formatButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const format = this.dataset.format;
      applyFormat(format, textarea);
    });
  });
}

function applyFormat(format, textarea) {
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selectedText = textarea.value.substring(start, end);
  let replacement = '';
  
  switch(format) {
    case 'bold':
      replacement = `**${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}**`;
      break;
    case 'italic':
      replacement = `*${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}*`;
      break;
    case 'code':
      replacement = `\`${selectedText || 'ã‚³ãƒ¼ãƒ‰'}\``;
      break;
    case 'list':
      replacement = `- ${selectedText || 'ãƒªã‚¹ãƒˆé …ç›®'}`;
      break;
    case 'quote':
      replacement = `> ${selectedText || 'å¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆ'}`;
      break;
  }
  
  textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
  textarea.focus();
  textarea.setSelectionRange(start, start + replacement.length);
}

// Form Validation
function setupFormValidation() {
  const form = document.querySelector('.new-request-form');
  
  form.addEventListener('submit', function(e) {
    if (!validateForm()) {
      e.preventDefault();
    }
  });
}

function validateForm() {
  const requiredFields = document.querySelectorAll('[required]');
  let isValid = true;
  
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.classList.add('error');
      isValid = false;
    } else {
      field.classList.remove('error');
    }
  });
  
  if (!isValid) {
    showError('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    // Scroll to first error
    const firstError = document.querySelector('.error');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
  
  return isValid;
}

// Draft Functionality
function setupDraftFunctionality() {
  loadDraft();
}

function saveDraft() {
  const draftData = {
    name: document.getElementById('request-requester-name').value,
    email: document.getElementById('request-requester-email').value,
    subject: document.getElementById('request-subject').value,
    description: document.getElementById('request-description').value,
    priority: document.querySelector('input[name="request[priority]"]:checked')?.value,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('new_request_draft', JSON.stringify(draftData));
  
  // Show feedback
  const draftBtn = document.querySelector('.btn-draft .btn-text');
  const originalText = draftBtn.textContent;
  draftBtn.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
  
  setTimeout(() => {
    draftBtn.textContent = originalText;
  }, 2000);
}

function loadDraft() {
  const savedDraft = localStorage.getItem('new_request_draft');
  if (savedDraft) {
    try {
      const draftData = JSON.parse(savedDraft);
      
      if (confirm('ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ã€‚èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById('request-requester-name').value = draftData.name || '';
        document.getElementById('request-requester-email').value = draftData.email || '';
        document.getElementById('request-subject').value = draftData.subject || '';
        document.getElementById('request-description').value = draftData.description || '';
        
        if (draftData.priority) {
          const priorityRadio = document.querySelector(`input[name="request[priority]"][value="${draftData.priority}"]`);
          if (priorityRadio) priorityRadio.checked = true;
        }
      }
    } catch (e) {
      console.error('Error loading draft:', e);
    }
  }
}

// Auto-save
function setupAutoSave() {
  setInterval(function() {
    const subject = document.getElementById('request-subject').value.trim();
    const description = document.getElementById('request-description').value.trim();
    
    if (subject || description) {
      saveDraft();
    }
  }, 60000); // Auto-save every minute
}

// Preview Functionality
function showPreview() {
  const name = document.getElementById('request-requester-name').value;
  const email = document.getElementById('request-requester-email').value;
  const subject = document.getElementById('request-subject').value;
  const description = document.getElementById('request-description').value;
  const priority = document.querySelector('input[name="request[priority]"]:checked');
  
  const previewBody = document.getElementById('preview-body');
  previewBody.innerHTML = `
    <div class="preview-request">
      <div class="preview-meta">
        <div class="requester-info">
          <strong>å·®å‡ºäºº:</strong> ${name} &lt;${email}&gt;
        </div>
        ${priority ? `<div class="priority-info"><strong>å„ªå…ˆåº¦:</strong> ${priority.nextElementSibling.querySelector('.priority-name').textContent}</div>` : ''}
      </div>
      <div class="preview-subject">
        <h3>${subject || 'ä»¶åãªã—'}</h3>
      </div>
      <div class="preview-description">
        ${markdownToHtml(description) || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã—'}
      </div>
    </div>
  `;
  
  document.getElementById('preview-modal').style.display = 'block';
}

function closePreview() {
  document.getElementById('preview-modal').style.display = 'none';
}

// Utility Functions
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function markdownToHtml(markdown) {
  if (!markdown) return '';
  
  return markdown
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/\n/g, '<br>');
}

function removeFile(index) {
  const fileInput = document.getElementById('request-attachments');
  const dt = new DataTransfer();
  const files = fileInput.files;
  
  for (let i = 0; i < files.length; i++) {
    if (i !== index) {
      dt.items.add(files[i]);
    }
  }
  
  fileInput.files = dt.files;
  displayFiles(fileInput.files);
}

function showError(message) {
  // Simple error display - could be enhanced with a proper notification system
  alert(message);
}

function toggleMarkdownHelp() {
  const helpDiv = document.getElementById('markdown-help');
  helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
}

function openChat() {
  // Chat integration would go here
  if (window.zE) {
    window.zE('webWidget', 'open');
  } else {
    alert('ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
  }
}

// Form cleanup on successful submission
window.addEventListener('beforeunload', function() {
  // Only clear draft if form is being submitted successfully
  if (document.querySelector('.new-request-form').classList.contains('submitting')) {
    localStorage.removeItem('new_request_draft');
  }
});
</script>