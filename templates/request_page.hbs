<div class="request-page-container">
  <nav class="request-breadcrumbs">
    <ol class="breadcrumbs">
      <li class="breadcrumbs-item">
        <a href="{{help_center.url}}">{{help_center.name}}</a>
      </li>
      <li class="breadcrumbs-item">
        <a href="{{help_center.url}}/requests">ã‚µãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ</a>
      </li>
    </ol>
  </nav>

  <header class="request-header">
    <h1 class="request-title">
      {{#if request}}
        ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #{{request.id}}
      {{else}}
        æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      {{/if}}
    </h1>
    
    {{#if request}}
    <div class="request-status-bar">
      <div class="request-status request-status--{{request.status}}">
        <span class="status-icon">
          {{#is request.status 'new'}}ğŸ†•{{/is}}
          {{#is request.status 'open'}}ğŸ“–{{/is}}
          {{#is request.status 'pending'}}â³{{/is}}
          {{#is request.status 'solved'}}âœ…{{/is}}
          {{#is request.status 'closed'}}ğŸ“{{/is}}
        </span>
        <span class="status-text">
          {{#is request.status 'new'}}æ–°è¦{{/is}}
          {{#is request.status 'open'}}å¯¾å¿œä¸­{{/is}}
          {{#is request.status 'pending'}}ä¿ç•™ä¸­{{/is}}
          {{#is request.status 'solved'}}è§£æ±ºæ¸ˆã¿{{/is}}
          {{#is request.status 'closed'}}å®Œäº†{{/is}}
        </span>
      </div>
      
      {{#if request.priority}}
      <div class="request-priority request-priority--{{request.priority}}">
        <span class="priority-icon">
          {{#is request.priority 'urgent'}}ğŸ”´{{/is}}
          {{#is request.priority 'high'}}ğŸŸ {{/is}}
          {{#is request.priority 'normal'}}ğŸŸ¡{{/is}}
          {{#is request.priority 'low'}}ğŸŸ¢{{/is}}
        </span>
        <span class="priority-text">
          {{#is request.priority 'urgent'}}ç·Šæ€¥{{/is}}
          {{#is request.priority 'high'}}é«˜{{/is}}
          {{#is request.priority 'normal'}}é€šå¸¸{{/is}}
          {{#is request.priority 'low'}}ä½{{/is}}
        </span>
      </div>
      {{/if}}
    </div>
    {{/if}}
  </header>

  <main class="request-main">
    {{#if request}}
    <!-- Existing Request View -->
    <div class="request-details">
      <div class="request-info">
        <h2 class="request-subject">{{request.subject}}</h2>
        
        <div class="request-meta">
          <div class="request-meta-item">
            <span class="meta-label">ä½œæˆæ—¥:</span>
            <time class="meta-value" datetime="{{request.created_at}}">
              {{date request.created_at}}
            </time>
          </div>
          
          {{#if request.updated_at}}
          <div class="request-meta-item">
            <span class="meta-label">æœ€çµ‚æ›´æ–°:</span>
            <time class="meta-value" datetime="{{request.updated_at}}">
              {{date request.updated_at timeago=true}}
            </time>
          </div>
          {{/if}}
          
          {{#if request.assignee}}
          <div class="request-meta-item">
            <span class="meta-label">æ‹…å½“è€…:</span>
            <div class="assignee-info">
              {{#if request.assignee.avatar_url}}
              <img src="{{request.assignee.avatar_url}}" alt="{{request.assignee.name}}" class="assignee-avatar" loading="lazy">
              {{/if}}
              <span class="assignee-name">{{request.assignee.name}}</span>
            </div>
          </div>
          {{/if}}
          
          {{#if request.organization}}
          <div class="request-meta-item">
            <span class="meta-label">çµ„ç¹”:</span>
            <span class="meta-value">{{request.organization.name}}</span>
          </div>
          {{/if}}
        </div>
        
        {{#if request.custom_fields}}
        <div class="request-custom-fields">
          <h3>è¿½åŠ æƒ…å ±</h3>
          <dl class="custom-fields-list">
            {{#each request.custom_fields}}
            <dt class="field-label">{{title}}:</dt>
            <dd class="field-value">{{value}}</dd>
            {{/each}}
          </dl>
        </div>
        {{/if}}
      </div>

      <!-- Conversation -->
      <div class="request-conversation">
        <h3>ä¼šè©±å±¥æ­´</h3>
        
        {{#if request.comments}}
        <ul class="conversation-list">
          {{#each request.comments}}
          <li class="conversation-item">
            <article class="conversation-comment">
              <div class="comment-header">
                <div class="comment-author">
                  {{#if author.avatar_url}}
                  <img src="{{author.avatar_url}}" alt="{{author.name}}" class="comment-avatar" loading="lazy">
                  {{/if}}
                  <div class="author-info">
                    <span class="author-name">{{author.name}}</span>
                    {{#if author.agent}}
                    <span class="author-badge">ã‚µãƒãƒ¼ãƒˆ</span>
                    {{/if}}
                  </div>
                </div>
                
                <time class="comment-date" datetime="{{created_at}}">
                  {{date created_at}}
                </time>
              </div>
              
              <div class="comment-body">
                {{{body}}}
              </div>
              
              {{#if attachments}}
              <div class="comment-attachments">
                <h4>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h4>
                <ul class="attachments-list">
                  {{#each attachments}}
                  <li class="attachment-item">
                    <a href="{{url}}" class="attachment-link" target="_blank">
                      <span class="attachment-icon">ğŸ“</span>
                      <span class="attachment-name">{{filename}}</span>
                      {{#if size}}
                      <span class="attachment-size">({{size}})</span>
                      {{/if}}
                    </a>
                  </li>
                  {{/each}}
                </ul>
              </div>
              {{/if}}
            </article>
          </li>
          {{/each}}
        </ul>
        {{else}}
        <div class="conversation-empty">
          <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {{/if}}

        <!-- Reply Form -->
        {{#unless request.solved}}
        {{#unless request.closed}}
        <div class="reply-form-section">
          <h3>è¿”ä¿¡ã™ã‚‹</h3>
          <form class="reply-form" method="post" action="{{request.url}}/comments" enctype="multipart/form-data">
            <div class="form-group">
              <label for="comment-body" class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
              <textarea id="comment-body" name="comment[body]" class="form-textarea" 
                        placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required rows="6"></textarea>
            </div>
            
            <div class="form-group">
              <label for="comment-attachments" class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
              <div class="file-upload-area">
                <input type="file" id="comment-attachments" name="comment[attachments][]" 
                       class="file-input" multiple accept="image/*,.pdf,.doc,.docx,.txt">
                <label for="comment-attachments" class="file-upload-label">
                  <span class="upload-icon">ğŸ“</span>
                  <span class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</span>
                </label>
                <div class="file-list"></div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">è¿”ä¿¡ã‚’é€ä¿¡</button>
              {{#if request.can_be_solved_by_me}}
              <button type="button" class="btn btn-success request-solve" data-request-id="{{request.id}}">
                è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹
              </button>
              {{/if}}
            </div>
          </form>
        </div>
        {{/unless}}
        {{/unless}}
      </div>
    </div>

    {{else}}
    <!-- New Request Form -->
    <div class="new-request-form">
      <div class="form-intro">
        <p>ãŠå›°ã‚Šã®ã“ã¨ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚è©³ç´°ãªæƒ…å ±ã‚’ã„ãŸã ã‘ã‚‹ã¨ã€ã‚ˆã‚Šè¿…é€Ÿã§çš„ç¢ºãªã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã§ãã¾ã™ã€‚</p>
      </div>

      <form class="request-form" method="post" action="{{help_center.url}}/requests" enctype="multipart/form-data">
        <div class="form-group">
          <label for="request-subject" class="form-label required">ä»¶å</label>
          <input type="text" id="request-subject" name="request[subject]" class="form-input" 
                 placeholder="å•é¡Œã®æ¦‚è¦ã‚’ç°¡æ½”ã«è¨˜å…¥ã—ã¦ãã ã•ã„" required>
        </div>

        {{#if request_types}}
        <div class="form-group">
          <label for="request-type" class="form-label">ãŠå•ã„åˆã‚ã›ã®ç¨®é¡</label>
          <select id="request-type" name="request[ticket_type_id]" class="form-select">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            {{#each request_types}}
            <option value="{{id}}">{{name}}</option>
            {{/each}}
          </select>
        </div>
        {{/if}}

        <div class="form-group">
          <label for="request-description" class="form-label required">è©³ç´°</label>
          <textarea id="request-description" name="request[comment][body]" class="form-textarea" 
                    placeholder="å•é¡Œã®è©³ç´°ã€ç™ºç”ŸçŠ¶æ³ã€è©¦ã—ãŸã“ã¨ãªã©ã‚’å…·ä½“çš„ã«è¨˜å…¥ã—ã¦ãã ã•ã„" 
                    required rows="8"></textarea>
          <div class="form-hint">
            åŠ¹æœçš„ãªã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã«ä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
            <ul>
              <li>å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªæ‰‹é †</li>
              <li>æœŸå¾…ã—ã¦ã„ãŸçµæœã¨å®Ÿéš›ã®çµæœ</li>
              <li>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ã‚‹å ´åˆï¼‰</li>
              <li>ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã€OSç­‰ï¼‰</li>
            </ul>
          </div>
        </div>

        {{#if priority_options}}
        <div class="form-group">
          <label for="request-priority" class="form-label">å„ªå…ˆåº¦</label>
          <select id="request-priority" name="request[priority]" class="form-select">
            {{#each priority_options}}
            <option value="{{value}}" {{#if default}}selected{{/if}}>{{name}}</option>
            {{/each}}
          </select>
        </div>
        {{/if}}

        {{#if custom_fields}}
        <div class="form-section">
          <h3>è¿½åŠ æƒ…å ±</h3>
          {{#each custom_fields}}
          <div class="form-group">
            <label for="custom-field-{{id}}" class="form-label {{#if required}}required{{/if}}">
              {{title}}
            </label>
            
            {{#is type 'text'}}
            <input type="text" id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                   class="form-input" {{#if required}}required{{/if}}>
            {{/is}}
            
            {{#is type 'textarea'}}
            <textarea id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                      class="form-textarea" rows="3" {{#if required}}required{{/if}}></textarea>
            {{/is}}
            
            {{#is type 'dropdown'}}
            <select id="custom-field-{{id}}" name="request[custom_fields][{{id}}]" 
                    class="form-select" {{#if required}}required{{/if}}>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              {{#each options}}
              <option value="{{value}}">{{name}}</option>
              {{/each}}
            </select>
            {{/is}}
            
            {{#if description}}
            <div class="field-description">{{description}}</div>
            {{/if}}
          </div>
          {{/each}}
        </div>
        {{/if}}

        <div class="form-group">
          <label for="request-attachments" class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div class="file-upload-area">
            <input type="file" id="request-attachments" name="request[comment][attachments][]" 
                   class="file-input" multiple accept="image/*,.pdf,.doc,.docx,.txt,.zip">
            <label for="request-attachments" class="file-upload-label">
              <span class="upload-icon">ğŸ“</span>
              <span class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</span>
            </label>
            <div class="file-list"></div>
          </div>
          <div class="file-upload-hint">
            å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: ç”»åƒã€PDFã€Wordæ–‡æ›¸ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ZIPï¼ˆæœ€å¤§10MBï¼‰
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-large">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡</button>
          <a href="{{help_center.url}}" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
        </div>
      </form>
    </div>
    {{/if}}
  </main>

  <aside class="request-sidebar">
    {{#if request}}
    <div class="request-actions">
      <h3>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
      <div class="actions-list">
        {{#if request.can_be_solved_by_me}}
        <button class="btn btn-success btn-small request-solve" data-request-id="{{request.id}}">
          âœ… è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹
        </button>
        {{/if}}
        
        <a href="{{help_center.url}}/requests" class="btn btn-secondary btn-small">
          ğŸ“‹ ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã«æˆ»ã‚‹
        </a>
        
        <button class="btn btn-secondary btn-small request-print" onclick="window.print()">
          ğŸ–¨ï¸ å°åˆ·
        </button>
      </div>
    </div>

    {{#if related_articles}}
    <div class="related-articles">
      <h3>é–¢é€£è¨˜äº‹</h3>
      <ul class="related-articles-list">
        {{#each related_articles}}
        <li class="related-article-item">
          <a href="{{url}}" class="related-article-link">{{title}}</a>
        </li>
        {{/each}}
      </ul>
    </div>
    {{/if}}
    {{else}}
    <div class="request-help">
      <h3>ã‚µãƒãƒ¼ãƒˆæƒ…å ±</h3>
      <div class="help-content">
        <p>ã‚ˆã‚Šè¿…é€Ÿãªã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã«ï¼š</p>
        <ul class="help-tips">
          <li>å…·ä½“çš„ãªå•é¡Œã®èª¬æ˜ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„</li>
          <li>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯æ­£ç¢ºã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</li>
          <li>é–¢é€£ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ·»ä»˜ã—ã¦ãã ã•ã„</li>
          <li>å•é¡Œã®å†ç¾æ‰‹é †ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„</li>
        </ul>
      </div>
    </div>

    <div class="contact-options">
      <h3>ãã®ä»–ã®é€£çµ¡æ–¹æ³•</h3>
      <div class="contact-list">
        {{#if help_center.phone}}
        <div class="contact-item">
          <span class="contact-icon">ğŸ“</span>
          <div class="contact-info">
            <div class="contact-method">é›»è©±ã‚µãƒãƒ¼ãƒˆ</div>
            <div class="contact-value">{{help_center.phone}}</div>
          </div>
        </div>
        {{/if}}
        
        {{#if help_center.email}}
        <div class="contact-item">
          <span class="contact-icon">ğŸ“§</span>
          <div class="contact-info">
            <div class="contact-method">ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ</div>
            <div class="contact-value">{{help_center.email}}</div>
          </div>
        </div>
        {{/if}}
        
        {{#if community.url}}
        <div class="contact-item">
          <span class="contact-icon">ğŸ’¬</span>
          <div class="contact-info">
            <div class="contact-method">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</div>
            <a href="{{community.url}}" class="contact-link">è³ªå•ã‚’æŠ•ç¨¿</a>
          </div>
        </div>
        {{/if}}
      </div>
    </div>
    {{/if}}

    <div class="request-guidelines">
      <h3>ã‚µãƒãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼</h3>
      <ul class="guidelines-list">
        <li>é€šå¸¸ã®ãŠå•ã„åˆã‚ã›ã¯24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ã„ãŸã—ã¾ã™</li>
        <li>ç·Šæ€¥ã®ãŠå•ã„åˆã‚ã›ã¯å„ªå…ˆçš„ã«å¯¾å¿œã„ãŸã—ã¾ã™</li>
        <li>å–¶æ¥­æ™‚é–“: å¹³æ—¥ 9:00-18:00 (ç¥æ—¥ã‚’é™¤ã)</li>
        <li>è©³ç´°ãªæƒ…å ±ã‚’ã„ãŸã ã‘ã‚‹ã¨ã€ã‚ˆã‚Šè¿…é€Ÿãªå¯¾å¿œãŒå¯èƒ½ã§ã™</li>
      </ul>
    </div>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // File upload handling
  const fileInputs = document.querySelectorAll('.file-input');
  
  fileInputs.forEach(input => {
    const uploadArea = input.closest('.file-upload-area');
    const fileList = uploadArea.querySelector('.file-list');
    
    input.addEventListener('change', function() {
      displayFiles(this.files, fileList);
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      input.files = files;
      displayFiles(files, fileList);
    });
  });
  
  function displayFiles(files, container) {
    container.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <span class="file-name">${file.name}</span>
        <span class="file-size">(${formatFileSize(file.size)})</span>
        <button type="button" class="file-remove" data-index="${index}">Ã—</button>
      `;
      
      container.appendChild(fileItem);
    });
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // Request solve functionality
  const solveButtons = document.querySelectorAll('.request-solve');
  solveButtons.forEach(button => {
    button.addEventListener('click', function() {
      if (confirm('ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è§£æ±ºæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
        const requestId = this.dataset.requestId;
        // API call would go here
        console.log('Solving request', requestId);
        
        // Update UI
        this.textContent = 'è§£æ±ºæ¸ˆã¿';
        this.disabled = true;
        this.classList.remove('btn-success');
        this.classList.add('btn-secondary');
      }
    });
  });
  
  // Form validation
  const forms = document.querySelectorAll('.request-form, .reply-form');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          field.classList.add('error');
        } else {
          field.classList.remove('error');
        }
      });
      
      if (!isValid) {
        e.preventDefault();
        alert('å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      }
    });
  });
});
</script>