<div class="new-post-container">
  <nav class="new-post-breadcrumbs">
    <ol class="breadcrumbs">
      <li class="breadcrumbs-item">
        <a href="{{help_center.url}}">{{help_center.name}}</a>
      </li>
      {{#if community.url}}
      <li class="breadcrumbs-item">
        <a href="{{community.url}}">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</a>
      </li>
      {{/if}}
      <li class="breadcrumbs-item">
        æ–°ã—ã„æŠ•ç¨¿
      </li>
    </ol>
  </nav>

  <header class="new-post-header">
    <div class="new-post-title-section">
      <h1 class="new-post-title">æ–°ã—ã„æŠ•ç¨¿ã‚’ä½œæˆ</h1>
      <p class="new-post-description">
        ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼ã¨çŸ¥è­˜ã‚’å…±æœ‰ã—ã€è³ªå•ã‚„è­°è«–ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚
      </p>
    </div>
  </header>

  <main class="new-post-main">
    <form class="new-post-form" method="post" action="{{community.url}}/posts" enctype="multipart/form-data">
      <div class="form-section">
        <div class="form-group">
          <label for="post-title" class="form-label required">æŠ•ç¨¿ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="post-title" name="post[title]" class="form-input form-input--large" 
                 placeholder="æŠ•ç¨¿ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required maxlength="255">
          <div class="form-hint">
            å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆæœ€å¤§255æ–‡å­—ï¼‰
          </div>
        </div>

        {{#if topics}}
        <div class="form-group">
          <label for="post-topic" class="form-label">ãƒˆãƒ”ãƒƒã‚¯</label>
          <select id="post-topic" name="post[topic_id]" class="form-select">
            <option value="">ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            {{#each topics}}
            <option value="{{id}}">{{name}}</option>
            {{/each}}
          </select>
          <div class="form-hint">
            æŠ•ç¨¿ã«æœ€é©ãªãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
        </div>
        {{/if}}

        <div class="form-group">
          <label for="post-body" class="form-label required">æŠ•ç¨¿å†…å®¹</label>
          <div class="editor-toolbar">
            <div class="editor-format-buttons">
              <button type="button" class="format-btn" data-format="bold" title="å¤ªå­—">
                <strong>B</strong>
              </button>
              <button type="button" class="format-btn" data-format="italic" title="æ–œä½“">
                <em>I</em>
              </button>
              <button type="button" class="format-btn" data-format="link" title="ãƒªãƒ³ã‚¯">
                ğŸ”—
              </button>
              <button type="button" class="format-btn" data-format="code" title="ã‚³ãƒ¼ãƒ‰">
                &lt;/&gt;
              </button>
              <button type="button" class="format-btn" data-format="quote" title="å¼•ç”¨">
                "
              </button>
              <button type="button" class="format-btn" data-format="list" title="ãƒªã‚¹ãƒˆ">
                â‰¡
              </button>
            </div>
          </div>
          <textarea id="post-body" name="post[details]" class="form-textarea form-textarea--large" 
                    placeholder="æŠ•ç¨¿ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required rows="12"></textarea>
          <div class="form-hint">
            Markdownè¨˜æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚è©³ç´°ãªå†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        {{#if post_types}}
        <div class="form-group">
          <label for="post-type" class="form-label">æŠ•ç¨¿ã®ç¨®é¡</label>
          <div class="post-type-options">
            {{#each post_types}}
            <label class="post-type-option">
              <input type="radio" name="post[post_type]" value="{{id}}" class="post-type-radio"
                     {{#if @first}}checked{{/if}}>
              <div class="post-type-card">
                <div class="post-type-icon">
                  {{#is id 'question'}}â“{{/is}}
                  {{#is id 'idea'}}ğŸ’¡{{/is}}
                  {{#is id 'problem'}}âš ï¸{{/is}}
                  {{#is id 'article'}}ğŸ“„{{/is}}
                </div>
                <div class="post-type-info">
                  <div class="post-type-name">{{name}}</div>
                  <div class="post-type-description">{{description}}</div>
                </div>
              </div>
            </label>
            {{/each}}
          </div>
        </div>
        {{/if}}

        <div class="form-group">
          <label for="post-tags" class="form-label">ã‚¿ã‚°</label>
          <input type="text" id="post-tags" name="post[label_names]" class="form-input" 
                 placeholder="ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: javascript, åˆå¿ƒè€…, è³ªå•ï¼‰">
          <div class="form-hint">
            é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¿ã‚°ã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§10å€‹ï¼‰
          </div>
        </div>

        <div class="form-group">
          <label for="post-attachments" class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div class="file-upload-area">
            <input type="file" id="post-attachments" name="post[attachments][]" 
                   class="file-input" multiple accept="image/*,.pdf,.doc,.docx,.txt,.zip">
            <label for="post-attachments" class="file-upload-label">
              <span class="upload-icon">ğŸ“</span>
              <span class="upload-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</span>
            </label>
            <div class="file-list"></div>
          </div>
          <div class="file-upload-hint">
            å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: ç”»åƒã€PDFã€Wordæ–‡æ›¸ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ZIPï¼ˆæœ€å¤§10MBï¼‰
          </div>
        </div>
      </div>

      <div class="form-actions">
        <div class="form-actions-main">
          <button type="submit" class="btn btn-primary btn-large">æŠ•ç¨¿ã‚’ä½œæˆ</button>
          <button type="button" class="btn btn-secondary post-preview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </div>
        <div class="form-actions-secondary">
          <a href="{{community.url}}" class="btn btn-link">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
          <button type="button" class="btn btn-link post-draft" data-action="save-draft">
            ä¸‹æ›¸ãä¿å­˜
          </button>
        </div>
      </div>
    </form>
  </main>

  <aside class="new-post-sidebar">
    <div class="posting-tips">
      <h3>æŠ•ç¨¿ã®ã‚³ãƒ„</h3>
      <div class="tips-content">
        <ul class="tips-list">
          <li>
            <strong>æ˜ç¢ºãªã‚¿ã‚¤ãƒˆãƒ«:</strong>
            å•é¡Œã‚„è³ªå•ã‚’ç°¡æ½”ã«è¡¨ç¾ã—ã¦ãã ã•ã„
          </li>
          <li>
            <strong>è©³ç´°ãªèª¬æ˜:</strong>
            èƒŒæ™¯æƒ…å ±ã‚„è©¦ã—ãŸã“ã¨ã‚’å«ã‚ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„
          </li>
          <li>
            <strong>é©åˆ‡ãªãƒˆãƒ”ãƒƒã‚¯:</strong>
            é–¢é€£ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„
          </li>
          <li>
            <strong>ã‚¿ã‚°ã®æ´»ç”¨:</strong>
            æ¤œç´¢ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
          </li>
          <li>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜:</strong>
            ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã¨ç†è§£ã—ã‚„ã™ããªã‚Šã¾ã™
          </li>
        </ul>
      </div>
    </div>

    <div class="community-guidelines">
      <h3>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</h3>
      <div class="guidelines-content">
        <ul class="guidelines-list">
          <li>ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å°Šé‡ã—ã€ç¤¼å„€æ­£ã—ãã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„</li>
          <li>é‡è¤‡æŠ•ç¨¿ã‚’é¿ã‘ã‚‹ãŸã‚ã€æ—¢å­˜ã®æŠ•ç¨¿ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</li>
          <li>ã‚¹ãƒ‘ãƒ ã‚„ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æŠ•ç¨¿ã—ãªã„ã§ãã ã•ã„</li>
          <li>å€‹äººæƒ…å ±ã‚„æ©Ÿå¯†æƒ…å ±ã®å…±æœ‰ã¯é¿ã‘ã¦ãã ã•ã„</li>
        </ul>
      </div>
    </div>

    {{#if popular_topics}}
    <div class="popular-topics">
      <h3>äººæ°—ã®ãƒˆãƒ”ãƒƒã‚¯</h3>
      <ul class="popular-topics-list">
        {{#each popular_topics}}
        <li class="popular-topic-item">
          <a href="{{url}}" class="popular-topic-link">
            <span class="topic-name">{{name}}</span>
            <span class="topic-count">({{posts_count}})</span>
          </a>
        </li>
        {{/each}}
      </ul>
    </div>
    {{/if}}

    <div class="markdown-help">
      <h3>Markdownè¨˜æ³•</h3>
      <div class="markdown-examples">
        <div class="markdown-example">
          <div class="markdown-syntax">**å¤ªå­—**</div>
          <div class="markdown-result"><strong>å¤ªå­—</strong></div>
        </div>
        <div class="markdown-example">
          <div class="markdown-syntax">*æ–œä½“*</div>
          <div class="markdown-result"><em>æ–œä½“</em></div>
        </div>
        <div class="markdown-example">
          <div class="markdown-syntax">[ãƒªãƒ³ã‚¯](URL)</div>
          <div class="markdown-result">ãƒªãƒ³ã‚¯</div>
        </div>
        <div class="markdown-example">
          <div class="markdown-syntax">`ã‚³ãƒ¼ãƒ‰`</div>
          <div class="markdown-result"><code>ã‚³ãƒ¼ãƒ‰</code></div>
        </div>
        <div class="markdown-example">
          <div class="markdown-syntax">> å¼•ç”¨</div>
          <div class="markdown-result">å¼•ç”¨</div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Preview Modal -->
<div class="preview-modal" id="preview-modal" style="display: none;">
  <div class="preview-modal-overlay" onclick="closePreview()"></div>
  <div class="preview-modal-content">
    <div class="preview-modal-header">
      <h3 class="preview-modal-title">æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <button class="preview-modal-close" onclick="closePreview()">Ã—</button>
    </div>
    <div class="preview-modal-body">
      <div class="preview-content" id="preview-content"></div>
    </div>
    <div class="preview-modal-footer">
      <button class="btn btn-primary" onclick="closePreview()">ç·¨é›†ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // File upload handling
  const fileInput = document.getElementById('post-attachments');
  const uploadArea = fileInput.closest('.file-upload-area');
  const fileList = uploadArea.querySelector('.file-list');
  
  fileInput.addEventListener('change', function() {
    displayFiles(this.files, fileList);
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('drag-over');
  });
  
  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    fileInput.files = files;
    displayFiles(files, fileList);
  });
  
  function displayFiles(files, container) {
    container.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.innerHTML = `
        <span class="file-name">${file.name}</span>
        <span class="file-size">(${formatFileSize(file.size)})</span>
        <button type="button" class="file-remove" data-index="${index}">Ã—</button>
      `;
      
      container.appendChild(fileItem);
    });
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // Format buttons
  const formatButtons = document.querySelectorAll('.format-btn');
  const textarea = document.getElementById('post-body');
  
  formatButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const format = this.dataset.format;
      insertFormat(format, textarea);
    });
  });
  
  function insertFormat(format, textarea) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    let replacement = '';
    
    switch(format) {
      case 'bold':
        replacement = `**${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}**`;
        break;
      case 'italic':
        replacement = `*${selectedText || 'ãƒ†ã‚­ã‚¹ãƒˆ'}*`;
        break;
      case 'link':
        replacement = `[${selectedText || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ'}](URL)`;
        break;
      case 'code':
        replacement = `\`${selectedText || 'ã‚³ãƒ¼ãƒ‰'}\``;
        break;
      case 'quote':
        replacement = `> ${selectedText || 'å¼•ç”¨ãƒ†ã‚­ã‚¹ãƒˆ'}`;
        break;
      case 'list':
        replacement = `- ${selectedText || 'ãƒªã‚¹ãƒˆé …ç›®'}`;
        break;
    }
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
  }
  
  // Preview functionality
  const previewBtn = document.querySelector('.post-preview');
  if (previewBtn) {
    previewBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showPreview();
    });
  }
  
  function showPreview() {
    const title = document.getElementById('post-title').value;
    const body = document.getElementById('post-body').value;
    const topic = document.getElementById('post-topic')?.selectedOptions[0]?.textContent || '';
    
    const previewContent = document.getElementById('preview-content');
    previewContent.innerHTML = `
      <div class="preview-post">
        <div class="preview-header">
          <h2 class="preview-title">${title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</h2>
          ${topic ? `<div class="preview-topic">${topic}</div>` : ''}
        </div>
        <div class="preview-body">${markdownToHtml(body) || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã—'}</div>
      </div>
    `;
    
    document.getElementById('preview-modal').style.display = 'block';
  }
  
  function markdownToHtml(markdown) {
    return markdown
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code>$1</code>')
      .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/\n/g, '<br>');
  }
  
  window.closePreview = function() {
    document.getElementById('preview-modal').style.display = 'none';
  };
  
  // Draft functionality
  const draftBtn = document.querySelector('.post-draft');
  if (draftBtn) {
    draftBtn.addEventListener('click', function() {
      saveDraft();
    });
  }
  
  function saveDraft() {
    const draftData = {
      title: document.getElementById('post-title').value,
      body: document.getElementById('post-body').value,
      topic_id: document.getElementById('post-topic')?.value,
      tags: document.getElementById('post-tags').value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('community_post_draft', JSON.stringify(draftData));
    
    // Show feedback
    draftBtn.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
    draftBtn.disabled = true;
    setTimeout(() => {
      draftBtn.textContent = 'ä¸‹æ›¸ãä¿å­˜';
      draftBtn.disabled = false;
    }, 2000);
  }
  
  // Load draft on page load
  const savedDraft = localStorage.getItem('community_post_draft');
  if (savedDraft) {
    const draftData = JSON.parse(savedDraft);
    if (confirm('ä¿å­˜ã•ã‚ŒãŸä¸‹æ›¸ããŒã‚ã‚Šã¾ã™ã€‚èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
      document.getElementById('post-title').value = draftData.title || '';
      document.getElementById('post-body').value = draftData.body || '';
      if (document.getElementById('post-topic')) {
        document.getElementById('post-topic').value = draftData.topic_id || '';
      }
      document.getElementById('post-tags').value = draftData.tags || '';
    }
  }
  
  // Form validation
  const form = document.querySelector('.new-post-form');
  form.addEventListener('submit', function(e) {
    const title = document.getElementById('post-title').value.trim();
    const body = document.getElementById('post-body').value.trim();
    
    if (!title || !body) {
      e.preventDefault();
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨æŠ•ç¨¿å†…å®¹ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
      return;
    }
    
    // Clear draft on successful submission
    localStorage.removeItem('community_post_draft');
  });
  
  // Auto-save draft every 30 seconds
  setInterval(function() {
    const title = document.getElementById('post-title').value.trim();
    const body = document.getElementById('post-body').value.trim();
    
    if (title || body) {
      saveDraft();
    }
  }, 30000);
});
</script>